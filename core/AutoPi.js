!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("qs")):"function"==typeof define&&define.amd?define(["exports","qs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).AutoPi={},e.qs)}(this,(function(e,t){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var r=i(t);function n(e,t,i="/"){let r=t?.split(i);r.shift();let n=e;for(;r.length>0;){if("object"!=typeof n)return n;let e=r.shift();n=e.includes("__")?n[e.replace("__","")]:n[e]}return n}class s{constructor(e,t,i,r){this.API=r,this.url=e,this.data=t,this.tempConfig=i,this.openApiConfig=null,this.currentService={},this.apiConfig={url:null,method:null,headers:null,data:{},params:{}},this.warnRequiredParams=[],this.warnTypeParams=[]}init(){this.getOpenApiConfig(),this.verifyOpenApiConfig(),this.initApiBaseConfig();try{this.initApiData()}catch(e){console.error(e),console.error({url:this.url,data:this.data}),this.apiConfig.data=this.data}this.readTempConfig()}getOpenApiConfig(){let{url:e}=this;for(let t of this.API)if(t.paths[e]){this.openApiConfig=t.paths[e],this.currentService=t;break}}verifyOpenApiConfig(){let{url:e,openApiConfig:t,tempConfig:i}=this;if(!t)throw Error(`API "${e}" NOT FOUND`);if(Object.keys(t).length>1&&!i?.method)throw Error(`API "${e}" has multiple method, you must set method for this api`)}initApiBaseConfig(){let{url:e,apiConfig:t,currentService:i,data:r,tempConfig:n,openApiConfig:s}=this;for(i.basePath&&"/"!==i.basePath?t.url=i.basePath+e:t.url=e;/(\{\w+\})/.test(t.url);)t.url=t.url.replace(RegExp.$1,r[RegExp.$1.substring(1,RegExp.$1.length-1)]);t.method=Object.keys(s)[0],n&&n.method&&(t.method=n.method),t.headers={"Content-Type":"application/json;charset=utf-8"}}initApiData(){let e=this.openApiConfig[this.apiConfig.method].parameters,t=this.openApiConfig[this.apiConfig.method].requestBody;if("[object Array]"===Object.prototype.toString.call(this.data))return this.apiConfig.data=this.data;if(e&&(this.apiConfig.data=function(e,t={},i){let s={};for(let o of e){if(!(t&&null!==t[o.name]&&void 0!==t[o.name]||t&&null!==t[o.name]&&void 0!==t[o.name]||o?.schema?.$ref)){o.required&&i.warnRequiredParams.push(o);continue}if(o.schema){let e=null;o.schema.$ref?(e=n(i.currentService,o.schema.$ref),s[o.name]=a(e,t,i)):(e=o.schema,s[o.name]=a(e,t[o.name],i))}else s[o.name]=a(o,t[o.name],i);if(o.schema)if(o.schema.type&&"array"===o.schema.type){if("[object Array]"===Object.prototype.toString.call(t))return t;s=s[o.name||"_Array"]}else o.schema.$ref&&(Object.assign(s,s[o.name]),delete s[o.name]);null===s[o.name]&&delete s[o.name],"path"===o.in&&delete s[o.name];let e=null;if("query"!==o.in||!s[o.name]&&0!==s[o.name]||(e||(e={}),e[o.name]=s[o.name],delete s[o.name]),e){if(!r.default.stringify(e))continue;i.apiConfig.url.includes("?")?i.apiConfig.url+=`&${r.default.stringify(e)}`:i.apiConfig.url+=`?${r.default.stringify(e)}`}}return s}(e,this.data,this)),t){let e=t.content["application/json"]?.schema?.$ref||t.content["*/*"]?.schema?.$ref;if(e){let t=n(this.currentService,e);this.apiConfig.data=a(t,this.data,this)}else this.apiConfig.data=this.data}this.printVerifyParameters()}printVerifyParameters(){let{url:e,data:t,warnRequiredParams:i,warnTypeParams:r}=this;if(i?.length){let t=i.map((e=>e.description)),r=i.map((e=>e.name));return console.error(`API "${e}" 中，必填项【${t.toString()}】未填写`),console.error(`API "${e}" parameters must contain "${r.toString()}"`),`必填项【${t.toString()}】未填写`}if(r?.length)for(let t of r)console.error(`API "${e}" parameter "${t.name}" is not ${t.type}`);(i?.length||r?.length)&&(console.error(`API "${e}" parameters is not support`),console.error("your data is",t))}readTempConfig=function(){let{tempConfig:e,apiConfig:t}=this;e&&(e.headers&&(e.headers=Object.assign(t.headers,e.headers)),Object.assign(t,e))}}function a(e,t={},i){if(!t&&0!==t&&""!==t&&!1!==t)return null;let r=null;if("object"===e?.type){if(r={},e.properties)for(let s in e.properties){let o=e.properties[s],l=t[s];if(null!=l)if(o.$ref){let e=n(i.currentService,o.$ref);"[object Object]"===Object.prototype.toString.call(l)?r[s]=a(e,l,i):i.warnTypeParams.push(o)}else r[s]=a(o,l,i);else e.required&&e.required.includes(s)&&i.warnRequiredParams.push(o)}else if("object"===e.additionalProperties.type)return t}else{if("array"===e?.type)return t;if("string"===e?.type){if("string"==typeof t)return t;if("object"==typeof t)return t;if("number"==typeof t)return t.toString();i.warnTypeParams.push(e)}else{if("integer"!==e?.type)return t;if("number"==typeof t)return t;if(!t)return null;if(!isNaN(t))return Number(t);i.warnTypeParams.push(e)}}return r}class o{constructor(e,t){this.service=e,this.API=t,this.waitList=[],this.startList=[],this.log=[],this.maxCount=5,this.logLength=100}getAxiosConfig(e,t,i){let r=new s(e,t,i,this.API);return r.init(),r.apiConfig}sendAxios(e,t,i){let r=this.getAxiosConfig(e,t,i);return this.queueSend(r)}sendAll(e){let t=new Array(e.length),i=[];for(let r in e){let n=e[r],s=this.getAxiosConfig(n.url,n.data,n.tempConfig);s.noMask=!0,i.push(this.queueSend(s).then((e=>{t[r]=e})))}return new Promise((e=>{Promise.all(i).finally((()=>{e(t)}))}))}sendFile(e,t,i){let r=this.getAxiosConfig(e,t,i);return r.headers["Content-Type"]="multipart/form-data",r.data=function(e,t=!1){let i=new FormData;for(let t in e)i.append(t,e[t]);return i}(t),this.service.request(r)}queueSend(e){return e._tempId=Math.random(),this.startList.length<this.maxCount?(this.startList.push(e),new Promise(((t,i)=>{this.sendOne(e,t,i)}))):(this.waitList.push(e),new Promise(((t,i)=>{let r=setInterval((()=>{this.waitList[0]===e&&this.startList.length<5&&(clearInterval(r),this.startList.push(e),this.sendOne(e,t,i),this.waitList.splice(0,1))}),100)})))}sendOne(e,t,i){this.service.request(e).then((i=>{this.startList.splice(this.startList.findIndex((t=>t._tempId=e._tempId)),1),this.addLog(e,i),t(i)})).catch((t=>{this.startList.splice(this.startList.findIndex((t=>t._tempId=e._tempId)),1),this.addLog(e,t),i(t)}))}addLog(e,t){const i={request:e,response:t};this.log.length>this.logLength&&this.log.pop(),this.log.unshift(i)}}e.useAutoAxios=function(e,t){return new o(e,t)},Object.defineProperty(e,"__esModule",{value:!0})}));
